<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Galaxy - Learn Git!</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        .navbar {
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .back-home {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px;
        }

        .game-header h1 {
            font-size: 1.4rem;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(90deg, #00d9ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-area {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        #gameCanvas {
            border-radius: 8px;
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.4);
            border: 2px solid rgba(138, 43, 226, 0.5);
        }

        .terminal {
            width: 220px;
            background: #1a1a2e;
            border-radius: 8px;
            border: 2px solid #333;
            font-family: 'Fira Code', monospace;
        }
        .terminal-header {
            background: #2d2d44;
            padding: 4px 6px;
            display: flex;
            gap: 3px;
        }
        .terminal-dot { width: 8px; height: 8px; border-radius: 50%; }
        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27ca40; }
        .terminal-body {
            padding: 6px;
            height: 320px;
            overflow-y: auto;
            font-size: 0.55rem;
            line-height: 1.4;
        }
        .cmd { color: #00d9ff; }
        .success { color: #27ca40; }
        .error { color: #ff5f56; }
        .commit { color: #a855f7; }
        .dim { opacity: 0.5; }

        /* Quiz Modal - The heart of learning */
        .quiz-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .quiz-modal.active { display: flex; }
        .quiz-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 25px 35px;
            text-align: center;
            max-width: 500px;
            border: 3px solid #00d9ff;
        }
        .quiz-content.wrong { border-color: #ff5f56; animation: shake 0.3s; }
        .quiz-content.correct { border-color: #27ca40; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .quiz-mode-label {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .quiz-icon { font-size: 2.2rem; margin-bottom: 8px; }
        .quiz-title { font-size: 1.2rem; font-weight: 900; margin-bottom: 6px; }
        .quiz-question { font-size: 0.9rem; opacity: 0.9; margin-bottom: 18px; }

        /* Multiple choice */
        .quiz-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .quiz-option {
            background: #2a2a4a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #fff;
        }
        .quiz-option:hover { border-color: #00d9ff; transform: translateY(-2px); }
        .quiz-option.correct-choice { border-color: #27ca40; background: #1a3a1a; }
        .quiz-option.wrong-choice { border-color: #ff5f56; background: #3a1a1a; }

        /* Scramble mode */
        .scramble-container {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .scramble-letter {
            background: #2a2a4a;
            border: 2px solid #444;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            color: #fff;
            transition: all 0.15s;
        }
        .scramble-letter:hover { border-color: #00d9ff; transform: translateY(-2px); }
        .scramble-letter.used { opacity: 0.3; pointer-events: none; }
        .scramble-answer {
            display: flex;
            gap: 4px;
            justify-content: center;
            min-height: 40px;
            margin-bottom: 10px;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .scramble-answer-letter {
            background: #00d9ff;
            color: #000;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Fill in blank / Type mode */
        .type-input {
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            width: 100%;
            max-width: 250px;
            text-align: center;
            margin-bottom: 12px;
        }
        .type-input:focus { outline: none; border-color: #00d9ff; }
        .type-input.correct { border-color: #27ca40; background: #1a3a1a; }
        .type-input.wrong { border-color: #ff5f56; background: #3a1a1a; }
        .type-hint {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 10px;
        }
        .submit-btn {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }
        .submit-btn:hover { transform: translateY(-2px); }

        .quiz-feedback {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            display: none;
        }
        .quiz-feedback.show { display: block; }
        .quiz-feedback.wrong { background: rgba(255,95,86,0.2); border: 1px solid #ff5f56; color: #ff5f56; }
        .quiz-feedback.correct { background: rgba(39,202,64,0.2); border: 1px solid #27ca40; color: #27ca40; }

        /* Progress indicator */
        .mastery-bar {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }
        .mastery-label { font-size: 0.7rem; opacity: 0.6; margin-bottom: 4px; }
        .mastery-track {
            background: #1a1a2e;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        .mastery-fill {
            height: 100%;
            background: linear-gradient(90deg, #a855f7, #00d9ff);
            transition: width 0.3s;
        }

        /* Death modal - Now a quiz! */
        .death-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .death-modal.active { display: flex; }
        .death-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
            border-radius: 16px;
            border: 3px solid #ff5f56;
            padding: 25px 30px;
            text-align: center;
            max-width: 550px;
        }
        .death-content h2 { color: #ff5f56; font-size: 1.6rem; margin-bottom: 8px; }
        .death-question { font-size: 0.9rem; opacity: 0.8; margin-bottom: 12px; }
        .death-lives { font-size: 1.1rem; margin-bottom: 15px; }
        .death-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .death-option {
            background: #2a2a4a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 10px 8px;
            cursor: pointer;
            font-family: 'Fira Code', monospace;
            font-size: 0.7rem;
            color: #fff;
            transition: all 0.15s;
        }
        .death-option:hover { border-color: #00d9ff; transform: translateY(-2px); }
        .death-option.correct { border-color: #27ca40; background: #1a3a1a; }
        .death-option.wrong { border-color: #ff5f56; background: #3a1a1a; }
        .death-option.disabled { opacity: 0.3; pointer-events: none; }
        .death-feedback {
            font-size: 0.85rem;
            min-height: 20px;
            margin-top: 8px;
        }
        .death-feedback.wrong { color: #ff5f56; }
        .death-feedback.correct { color: #27ca40; }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        .stat {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
        }
        .stat-label { opacity: 0.6; }
        .stat-value { font-weight: 700; color: #00d9ff; }

        /* Start screen */
        .start-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 400;
            text-align: center;
            padding: 20px;
        }
        .start-screen.hidden { display: none; }
        .start-screen h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #00d9ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .start-screen .subtitle { font-size: 1rem; opacity: 0.8; margin-bottom: 20px; }
        .start-screen .how-it-works {
            max-width: 450px;
            text-align: left;
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        .start-screen .how-it-works h3 { margin-bottom: 8px; color: #00d9ff; font-size: 0.95rem; }
        .start-screen .how-it-works p { margin-bottom: 5px; opacity: 0.85; }
        .btn {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            border: none;
            padding: 12px 35px;
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
        }
        .btn:hover { transform: translateY(-2px); }

        /* Level complete */
        .level-complete {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 300;
        }
        .level-complete.active { display: flex; }
        .level-complete h2 { font-size: 2rem; color: #27ca40; margin-bottom: 10px; }
        .level-complete .push-cmd {
            font-family: 'Fira Code', monospace;
            color: #00d9ff;
            margin-bottom: 15px;
        }

        .controls-hint { margin-top: 5px; opacity: 0.3; font-size: 0.65rem; }

        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: #fff; border-radius: 50%; animation: twinkle 2s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        @media (max-width: 850px) {
            .game-area { flex-direction: column; }
            .terminal { width: 100%; max-width: 650px; }
            .terminal-body { height: 80px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <h1>Git Galaxy</h1>
        <p class="subtitle">Master Git commands by playing!</p>

        <div class="how-it-works">
            <h3>How You'll Learn</h3>
            <p>üíé <strong>Collect ALL crystals</strong> in a zone ‚Üí Quiz on <code style="color:#00d9ff">git add</code></p>
            <p>üö© <strong>Reach checkpoint</strong> ‚Üí Quiz on <code style="color:#a855f7">git commit</code></p>
            <p>‚≠ê <strong>Reach the goal</strong> ‚Üí Quiz on <code style="color:#27ca40">git push</code></p>
            <p style="margin-top:10px;color:#ff5f56;font-weight:bold;font-size:0.85rem;">Wrong answer = redo the puzzle!</p>
            <p style="margin-top:6px;opacity:0.6;font-size:0.8rem;">Start with choices ‚Üí then unscramble ‚Üí then type it!</p>
        </div>

        <button class="btn" id="startBtn">START LEARNING</button>
        <p style="margin-top: 10px; font-size: 0.7rem; opacity: 0.3;">Arrow keys to move ‚Ä¢ Space to jump</p>
    </div>

    <!-- Quiz Modal -->
    <div class="quiz-modal" id="quizModal">
        <div class="quiz-content" id="quizContent">
            <div class="quiz-mode-label" id="quizModeLabel">Multiple Choice</div>
            <div class="quiz-icon" id="quizIcon">üì¶</div>
            <div class="quiz-title" id="quizTitle">File Collected!</div>
            <div class="quiz-question" id="quizQuestion">What command stages a file?</div>

            <!-- Multiple choice container -->
            <div class="quiz-options" id="quizOptions"></div>

            <!-- Scramble container -->
            <div id="scrambleContainer" style="display:none;">
                <div class="scramble-answer" id="scrambleAnswer"></div>
                <div class="scramble-container" id="scrambleLetters"></div>
                <button class="submit-btn" id="scrambleSubmit">Check Answer</button>
            </div>

            <!-- Type container -->
            <div id="typeContainer" style="display:none;">
                <div class="type-hint" id="typeHint"></div>
                <input type="text" class="type-input" id="typeInput" autocomplete="off" spellcheck="false">
                <button class="submit-btn" id="typeSubmit">Submit</button>
            </div>

            <div class="quiz-feedback" id="quizFeedback"></div>

            <div class="mastery-bar">
                <div class="mastery-label">Command Mastery: <span id="masteryText">0/8</span></div>
                <div class="mastery-track">
                    <div class="mastery-fill" id="masteryFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Death Modal - Now a QUIZ with many options! -->
    <div class="death-modal" id="deathModal">
        <div class="death-content">
            <h2>YOU DIED!</h2>
            <p class="death-question">Which command returns to your last save point?</p>
            <div class="death-lives">Lives: <span id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
            <div class="death-grid" id="deathGrid">
                <!-- Options populated by JS -->
            </div>
            <div class="death-feedback" id="deathFeedback"></div>
        </div>
    </div>

    <!-- Level Complete -->
    <div class="level-complete" id="levelComplete">
        <h2>LEVEL COMPLETE!</h2>
        <div class="push-cmd">$ git push origin main<br><span style="color:#27ca40">‚úì Pushed!</span></div>
        <button class="btn" id="nextLevelBtn">NEXT LEVEL</button>
    </div>

    <!-- Audio -->
    <audio id="sfxCollect" preload="auto" src="https://cdn.freesound.org/previews/341/341695_5858296-hq.mp3"></audio>
    <audio id="sfxCorrect" preload="auto" src="https://cdn.freesound.org/previews/270/270402_5123851-hq.mp3"></audio>
    <audio id="sfxWrong" preload="auto" src="https://cdn.freesound.org/previews/331/331912_3248244-hq.mp3"></audio>
    <audio id="sfxDeath" preload="auto" src="https://cdn.freesound.org/previews/350/350980_5450487-hq.mp3"></audio>
    <audio id="sfxJump" preload="auto" src="https://cdn.freesound.org/previews/369/369515_6687700-hq.mp3"></audio>
    <audio id="bgMusic" loop preload="auto" src="https://cdn.freesound.org/previews/442/442181_7482766-hq.mp3"></audio>

    <nav class="navbar">
        <a href="../../index.html" class="back-home">‚Üê Back</a>
        <span style="font-size:0.75rem;opacity:0.5;">Git Galaxy</span>
    </nav>

    <div class="game-wrapper">
        <div class="game-header"><h1>Git Galaxy</h1></div>

        <div class="game-area">
            <canvas id="gameCanvas" width="650" height="380"></canvas>
            <div class="terminal">
                <div class="terminal-header">
                    <div class="terminal-dot red"></div>
                    <div class="terminal-dot yellow"></div>
                    <div class="terminal-dot green"></div>
                </div>
                <div class="terminal-body" id="terminalBody">
                    <div class="dim">$ git init</div>
                    <div class="success">Ready!</div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="stat-label">Level:</span> <span class="stat-value" id="levelNum">1</span>/5</div>
            <div class="stat"><span class="stat-label">Lives:</span> <span class="stat-value" id="livesCount">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
            <div class="stat"><span class="stat-label">Staged:</span> <span class="stat-value" id="stagedCount">0</span></div>
            <div class="stat"><span class="stat-label">Commits:</span> <span class="stat-value" id="commitCount">0</span></div>
        </div>

        <div class="controls-hint">Arrow keys / WASD ‚Ä¢ Space to jump</div>
    </div>

    <script>
        // Stars background
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // === MASTERY SYSTEM ===
        // Track how many times each command has been practiced
        const mastery = {
            'git add': 0,
            'git commit': 0,
            'git push': 0
        };
        const MASTERY_LEVELS = {
            CHOICE: 0,      // 0-2: multiple choice
            SCRAMBLE: 3,    // 3-5: unscramble
            FILL: 6,        // 6-7: fill in blank (first letter given)
            TYPE: 8         // 8+: type from memory
        };
        const MAX_MASTERY = 10;

        function getMasteryMode(command) {
            const level = mastery[command] || 0;
            if (level < MASTERY_LEVELS.SCRAMBLE) return 'choice';
            if (level < MASTERY_LEVELS.FILL) return 'scramble';
            if (level < MASTERY_LEVELS.TYPE) return 'fill';
            return 'type';
        }

        // Camera
        let cameraX = 0;
        const CAMERA_LERP = 0.08;

        // Game state
        let currentLevel = 1;
        let gameRunning = false;
        let stagedFiles = [];
        let commitCount = 0;
        let lastCheckpoint = null;
        let hasCheckpoint = false;

        // Quiz state
        let currentQuiz = null;
        let scrambleAnswer = [];

        // File types
        const fileTypes = [
            { name: 'app.js', color: '#f1c40f' },
            { name: 'index.html', color: '#e74c3c' },
            { name: 'style.css', color: '#3498db' },
            { name: 'data.json', color: '#1abc9c' },
            { name: 'utils.js', color: '#9b59b6' },
        ];

        // All possible git commands (for wrong options)
        const allGitCommands = [
            'git add', 'git commit', 'git push', 'git pull',
            'git stash', 'git merge', 'git fetch', 'git clone',
            'git branch', 'git checkout', 'git reset', 'git status'
        ];

        // Quiz definitions - NO HINTS! Learning comes from trial and error
        const quizDefs = {
            add: {
                command: 'git add',
                icon: 'üì¶',
                title: 'Puzzle Complete!',
                question: 'Which command STAGES this file?',
                correct: 'git add'
            },
            commit: {
                command: 'git commit',
                icon: 'üö©',
                title: 'Checkpoint!',
                question: 'Which command SAVES your changes?',
                correct: 'git commit'
            },
            push: {
                command: 'git push',
                icon: '‚≠ê',
                title: 'Level Complete!',
                question: 'Which command sends to GitHub?',
                correct: 'git push'
            }
        };

        // Get random wrong options for quiz
        function getQuizOptions(correct, count = 4) {
            const wrong = allGitCommands.filter(c => c !== correct);
            const shuffledWrong = wrong.sort(() => Math.random() - 0.5).slice(0, count - 1);
            const options = [correct, ...shuffledWrong];
            return options.sort(() => Math.random() - 0.5);
        }

        // Player
        const player = {
            x: 50, y: 280,
            width: 24, height: 24,
            velX: 0, velY: 0,
            speed: 4, jumpPower: 11,
            onGround: false, facingRight: true
        };

        const gravity = 0.45;
        const friction = 0.85;

        // Levels
        // PUZZLE ZONES: Each "file" is now a mini-puzzle you must complete
        // Collect all crystals in a zone to trigger the git add quiz
        // Wrong answer = crystals respawn, try the puzzle again!

        const levels = [
            {
                // LEVEL 1: Long intro level with real platforming challenges
                width: 3500,
                platforms: [
                    // Starting area
                    { x: 0, y: 350, width: 150, height: 30 },
                    // First jumping section - stepping stones
                    { x: 200, y: 320, width: 50, height: 12 },
                    { x: 300, y: 290, width: 50, height: 12 },
                    { x: 400, y: 260, width: 50, height: 12 },
                    { x: 300, y: 230, width: 50, height: 12 },
                    { x: 200, y: 200, width: 50, height: 12 },
                    // Safe platform
                    { x: 500, y: 350, width: 120, height: 30 },
                    // Climbing section
                    { x: 680, y: 310, width: 60, height: 12 },
                    { x: 800, y: 270, width: 60, height: 12 },
                    { x: 920, y: 230, width: 60, height: 12 },
                    { x: 1040, y: 190, width: 60, height: 12 },
                    // Checkpoint 1 platform
                    { x: 1150, y: 350, width: 150, height: 30 },
                    // Descending jumps
                    { x: 1360, y: 300, width: 50, height: 12 },
                    { x: 1470, y: 250, width: 50, height: 12 },
                    { x: 1580, y: 200, width: 50, height: 12 },
                    { x: 1690, y: 250, width: 50, height: 12 },
                    { x: 1800, y: 300, width: 50, height: 12 },
                    // Middle safe zone
                    { x: 1900, y: 350, width: 120, height: 30 },
                    // Precision platforming
                    { x: 2080, y: 310, width: 40, height: 12 },
                    { x: 2180, y: 270, width: 40, height: 12 },
                    { x: 2280, y: 230, width: 40, height: 12 },
                    { x: 2380, y: 270, width: 40, height: 12 },
                    { x: 2480, y: 310, width: 40, height: 12 },
                    // Checkpoint 2 platform
                    { x: 2580, y: 350, width: 150, height: 30 },
                    // Final climb
                    { x: 2790, y: 300, width: 60, height: 12 },
                    { x: 2910, y: 250, width: 60, height: 12 },
                    { x: 3030, y: 200, width: 60, height: 12 },
                    { x: 3150, y: 150, width: 60, height: 12 },
                    // Goal platform
                    { x: 3280, y: 350, width: 150, height: 30 },
                ],
                // PUZZLE ZONES - crystals spread across platforms requiring real skill
                puzzleZones: [
                    {
                        // Zone 1: Collect crystals across stepping stones
                        ...fileTypes[0],
                        zoneX: 180, zoneY: 150, zoneW: 300, zoneH: 210,
                        crystals: [
                            { x: 215, y: 290 },  // On platform 1
                            { x: 315, y: 260 },  // On platform 2
                            { x: 415, y: 230 },  // On platform 3
                            { x: 315, y: 200 },  // On platform 4
                            { x: 215, y: 170 },  // On platform 5
                        ]
                    },
                    {
                        // Zone 2: Climbing challenge
                        ...fileTypes[1],
                        zoneX: 660, zoneY: 140, zoneW: 460, zoneH: 220,
                        crystals: [
                            { x: 695, y: 280 },
                            { x: 815, y: 240 },
                            { x: 935, y: 200 },
                            { x: 1055, y: 160 },
                        ]
                    },
                    {
                        // Zone 3: Descending path
                        ...fileTypes[2],
                        zoneX: 1340, zoneY: 150, zoneW: 520, zoneH: 210,
                        crystals: [
                            { x: 1375, y: 270 },
                            { x: 1485, y: 220 },
                            { x: 1595, y: 170 },
                            { x: 1705, y: 220 },
                            { x: 1815, y: 270 },
                        ]
                    },
                    {
                        // Zone 4: Precision jumps
                        ...fileTypes[3],
                        zoneX: 2060, zoneY: 180, zoneW: 480, zoneH: 180,
                        crystals: [
                            { x: 2095, y: 280 },
                            { x: 2195, y: 240 },
                            { x: 2295, y: 200 },
                            { x: 2395, y: 240 },
                            { x: 2495, y: 280 },
                        ]
                    },
                    {
                        // Zone 5: Final climb
                        ...fileTypes[4],
                        zoneX: 2770, zoneY: 100, zoneW: 460, zoneH: 260,
                        crystals: [
                            { x: 2805, y: 270 },
                            { x: 2925, y: 220 },
                            { x: 3045, y: 170 },
                            { x: 3165, y: 120 },
                        ]
                    },
                ],
                checkpoints: [
                    { x: 1200, y: 318 },
                    { x: 2630, y: 318 },
                ],
                goal: { x: 3340, y: 308 },
                spikes: [
                    { x: 150, y: 330, width: 50, height: 20 },
                    { x: 620, y: 330, width: 60, height: 20 },
                    { x: 1300, y: 330, width: 60, height: 20 },
                    { x: 2020, y: 330, width: 60, height: 20 },
                    { x: 2730, y: 330, width: 60, height: 20 },
                ],
                pits: [],
                bg: ['#1a0a2e', '#2d1b4e']
            },
            {
                width: 1800,
                platforms: [
                    { x: 0, y: 350, width: 180, height: 30 },
                    { x: 250, y: 300, width: 70, height: 12 },
                    { x: 390, y: 250, width: 70, height: 12 },
                    { x: 530, y: 350, width: 140, height: 30 },
                    { x: 740, y: 300, width: 70, height: 12 },
                    { x: 880, y: 250, width: 70, height: 12 },
                    { x: 1020, y: 350, width: 140, height: 30 },
                    { x: 1230, y: 290, width: 80, height: 12 },
                    { x: 1380, y: 240, width: 80, height: 12 },
                    { x: 1530, y: 350, width: 150, height: 30 },
                ],
                puzzleZones: [
                    {
                        ...fileTypes[0],
                        zoneX: 40, zoneY: 260, zoneW: 120, zoneH: 100,
                        crystals: [
                            { x: 60, y: 320 },
                            { x: 110, y: 320 },
                            { x: 140, y: 320 },
                        ]
                    },
                    {
                        ...fileTypes[1],
                        zoneX: 230, zoneY: 200, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 265, y: 270 },
                            { x: 310, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[2],
                        zoneX: 370, zoneY: 150, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 405, y: 220 },
                            { x: 440, y: 220 },
                        ]
                    },
                    {
                        ...fileTypes[3],
                        zoneX: 720, zoneY: 200, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 755, y: 270 },
                            { x: 795, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[4],
                        zoneX: 860, zoneY: 150, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 895, y: 220 },
                            { x: 935, y: 220 },
                        ]
                    },
                ],
                checkpoints: [
                    { x: 570, y: 318 },
                    { x: 1060, y: 318 },
                ],
                goal: { x: 1590, y: 308 },
                spikes: [
                    { x: 180, y: 330, width: 70, height: 20 },
                    { x: 670, y: 330, width: 70, height: 20 },
                ],
                pits: [],
                bg: ['#0a1628', '#1a3a5c']
            },
            {
                width: 2000,
                platforms: [
                    { x: 0, y: 350, width: 140, height: 30 },
                    { x: 210, y: 300, width: 70, height: 12 },
                    { x: 350, y: 250, width: 70, height: 12 },
                    { x: 490, y: 350, width: 120, height: 30 },
                    { x: 680, y: 290, width: 70, height: 12 },
                    { x: 820, y: 240, width: 70, height: 12 },
                    { x: 960, y: 350, width: 120, height: 30 },
                    { x: 1150, y: 300, width: 70, height: 12 },
                    { x: 1290, y: 250, width: 70, height: 12 },
                    { x: 1430, y: 200, width: 70, height: 12 },
                    { x: 1570, y: 350, width: 180, height: 30 },
                ],
                puzzleZones: [
                    {
                        ...fileTypes[0],
                        zoneX: 30, zoneY: 260, zoneW: 100, zoneH: 100,
                        crystals: [
                            { x: 50, y: 320 },
                            { x: 90, y: 320 },
                            { x: 110, y: 320 },
                        ]
                    },
                    {
                        ...fileTypes[1],
                        zoneX: 190, zoneY: 200, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 225, y: 270 },
                            { x: 265, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[2],
                        zoneX: 330, zoneY: 150, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 365, y: 220 },
                            { x: 405, y: 220 },
                        ]
                    },
                    {
                        ...fileTypes[3],
                        zoneX: 660, zoneY: 190, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 695, y: 260 },
                            { x: 735, y: 260 },
                        ]
                    },
                    {
                        ...fileTypes[4],
                        zoneX: 800, zoneY: 140, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 835, y: 210 },
                            { x: 875, y: 210 },
                        ]
                    },
                ],
                checkpoints: [
                    { x: 520, y: 318 },
                    { x: 1000, y: 318 },
                ],
                goal: { x: 1650, y: 308 },
                spikes: [
                    { x: 140, y: 330, width: 70, height: 20 },
                    { x: 610, y: 330, width: 70, height: 20 },
                    { x: 1080, y: 330, width: 70, height: 20 },
                ],
                pits: [
                    { x: 420, y: 380, width: 70 },
                    { x: 890, y: 380, width: 70 },
                ],
                bg: ['#1a0a0a', '#3d1a1a']
            },
            {
                width: 2200,
                platforms: [
                    { x: 0, y: 350, width: 100, height: 30 },
                    { x: 160, y: 300, width: 60, height: 12 },
                    { x: 280, y: 250, width: 60, height: 12 },
                    { x: 400, y: 200, width: 60, height: 12 },
                    { x: 520, y: 350, width: 100, height: 30 },
                    { x: 680, y: 290, width: 60, height: 12 },
                    { x: 800, y: 240, width: 60, height: 12 },
                    { x: 920, y: 350, width: 100, height: 30 },
                    { x: 1080, y: 300, width: 60, height: 12 },
                    { x: 1200, y: 250, width: 60, height: 12 },
                    { x: 1320, y: 200, width: 60, height: 12 },
                    { x: 1440, y: 350, width: 100, height: 30 },
                    { x: 1600, y: 280, width: 80, height: 12 },
                    { x: 1740, y: 230, width: 80, height: 12 },
                    { x: 1880, y: 350, width: 150, height: 30 },
                ],
                puzzleZones: [
                    {
                        ...fileTypes[0],
                        zoneX: 10, zoneY: 260, zoneW: 80, zoneH: 100,
                        crystals: [
                            { x: 30, y: 320 },
                            { x: 70, y: 320 },
                        ]
                    },
                    {
                        ...fileTypes[1],
                        zoneX: 140, zoneY: 200, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 175, y: 270 },
                            { x: 215, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[2],
                        zoneX: 260, zoneY: 150, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 295, y: 220 },
                            { x: 325, y: 220 },
                        ]
                    },
                    {
                        ...fileTypes[3],
                        zoneX: 660, zoneY: 190, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 695, y: 260 },
                            { x: 725, y: 260 },
                        ]
                    },
                    {
                        ...fileTypes[4],
                        zoneX: 1060, zoneY: 200, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 1095, y: 270 },
                            { x: 1125, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[0],
                        zoneX: 1580, zoneY: 180, zoneW: 100, zoneH: 110,
                        crystals: [
                            { x: 1615, y: 250 },
                            { x: 1655, y: 250 },
                        ]
                    },
                ],
                checkpoints: [
                    { x: 550, y: 318 },
                    { x: 950, y: 318 },
                    { x: 1470, y: 318 },
                ],
                goal: { x: 1940, y: 308 },
                spikes: [
                    { x: 100, y: 330, width: 60, height: 20 },
                    { x: 460, y: 180, width: 60, height: 20 },
                    { x: 620, y: 330, width: 60, height: 20 },
                    { x: 860, y: 220, width: 60, height: 20 },
                    { x: 1020, y: 330, width: 60, height: 20 },
                    { x: 1380, y: 180, width: 60, height: 20 },
                    { x: 1540, y: 330, width: 60, height: 20 },
                ],
                pits: [
                    { x: 240, y: 380, width: 60 },
                    { x: 860, y: 380, width: 60 },
                    { x: 1260, y: 380, width: 60 },
                ],
                bg: ['#0a1a0a', '#1a3d1a']
            },
            {
                width: 1400,
                platforms: [
                    { x: 0, y: 350, width: 350, height: 30 },
                    { x: 420, y: 300, width: 100, height: 12 },
                    { x: 590, y: 250, width: 100, height: 12 },
                    { x: 760, y: 200, width: 100, height: 12 },
                    { x: 930, y: 150, width: 100, height: 12 },
                    { x: 1100, y: 350, width: 200, height: 30 },
                ],
                puzzleZones: [
                    {
                        ...fileTypes[0],
                        zoneX: 60, zoneY: 260, zoneW: 120, zoneH: 100,
                        crystals: [
                            { x: 80, y: 320 },
                            { x: 120, y: 320 },
                            { x: 160, y: 320 },
                        ]
                    },
                    {
                        ...fileTypes[1],
                        zoneX: 180, zoneY: 260, zoneW: 120, zoneH: 100,
                        crystals: [
                            { x: 200, y: 320 },
                            { x: 240, y: 320 },
                            { x: 280, y: 320 },
                        ]
                    },
                    {
                        ...fileTypes[2],
                        zoneX: 400, zoneY: 200, zoneW: 120, zoneH: 110,
                        crystals: [
                            { x: 445, y: 270 },
                            { x: 485, y: 270 },
                        ]
                    },
                    {
                        ...fileTypes[3],
                        zoneX: 570, zoneY: 150, zoneW: 120, zoneH: 110,
                        crystals: [
                            { x: 615, y: 220 },
                            { x: 655, y: 220 },
                        ]
                    },
                    {
                        ...fileTypes[4],
                        zoneX: 740, zoneY: 100, zoneW: 120, zoneH: 110,
                        crystals: [
                            { x: 785, y: 170 },
                            { x: 825, y: 170 },
                        ]
                    },
                ],
                checkpoints: [
                    { x: 280, y: 318 },
                    { x: 1140, y: 318 },
                ],
                goal: { x: 1200, y: 308 },
                spikes: [],
                pits: [],
                bg: ['#1a0a2e', '#4a1a6e']
            }
        ];

        let currentLevelData = levels[0];
        let collectedFiles = []; // Completed puzzle zones
        let activeCheckpoints = [];

        // PUZZLE ZONE STATE
        // Track which crystals have been collected in each zone
        let zoneStates = []; // Array of { collected: Set of crystal indices, complete: bool }
        let currentZoneIndex = -1; // Which zone player is in (-1 = none)

        function playSound(id, vol = 0.5) {
            const s = document.getElementById(id);
            if (s) { s.currentTime = 0; s.volume = vol; s.play().catch(() => {}); }
        }

        function terminalLog(html) {
            const t = document.getElementById('terminalBody');
            const l = document.createElement('div');
            l.innerHTML = html;
            t.appendChild(l);
            t.scrollTop = t.scrollHeight;
        }

        function updateStats() {
            document.getElementById('stagedCount').textContent = stagedFiles.length;
            document.getElementById('commitCount').textContent = commitCount;
        }

        function updateMasteryUI(command) {
            const level = mastery[command] || 0;
            const pct = Math.min(100, (level / MAX_MASTERY) * 100);
            document.getElementById('masteryFill').style.width = pct + '%';
            document.getElementById('masteryText').textContent = `${level}/${MAX_MASTERY}`;
        }

        // === QUIZ SYSTEM ===
        function showQuiz(type, onCorrect) {
            const def = quizDefs[type];
            const mode = getMasteryMode(def.command);
            currentQuiz = { type, def, mode, onCorrect };

            // Update UI
            document.getElementById('quizIcon').textContent = def.icon;
            document.getElementById('quizTitle').textContent = def.title;
            document.getElementById('quizQuestion').textContent = def.question;
            updateMasteryUI(def.command);

            // Hide all containers
            document.getElementById('quizOptions').style.display = 'none';
            document.getElementById('scrambleContainer').style.display = 'none';
            document.getElementById('typeContainer').style.display = 'none';
            document.getElementById('quizFeedback').className = 'quiz-feedback';
            document.getElementById('quizContent').className = 'quiz-content';

            if (mode === 'choice') {
                setupChoiceQuiz(def);
                document.getElementById('quizModeLabel').textContent = 'Multiple Choice';
            } else if (mode === 'scramble') {
                setupScrambleQuiz(def);
                document.getElementById('quizModeLabel').textContent = 'Unscramble';
            } else if (mode === 'fill') {
                setupFillQuiz(def);
                document.getElementById('quizModeLabel').textContent = 'Fill in the Blank';
            } else {
                setupTypeQuiz(def);
                document.getElementById('quizModeLabel').textContent = 'Type It!';
            }

            document.getElementById('quizModal').classList.add('active');
        }

        function setupChoiceQuiz(def) {
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            optionsDiv.style.display = 'flex';

            // Get 4 random options (1 correct + 3 wrong)
            const options = getQuizOptions(def.correct, 4);
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = opt;
                btn.onclick = () => handleChoiceAnswer(opt, btn);
                optionsDiv.appendChild(btn);
            });
        }

        function handleChoiceAnswer(answer, btn) {
            const { def } = currentQuiz;
            document.querySelectorAll('.quiz-option').forEach(b => b.style.pointerEvents = 'none');

            if (answer === def.correct) {
                quizCorrect(btn);
            } else {
                quizWrong(btn, 'Wrong!');
            }
        }

        function setupScrambleQuiz(def) {
            document.getElementById('scrambleContainer').style.display = 'block';
            const letters = def.correct.split('');
            scrambleAnswer = [];

            // Shuffle letters
            const shuffled = [...letters].sort(() => Math.random() - 0.5);

            const answerDiv = document.getElementById('scrambleAnswer');
            const lettersDiv = document.getElementById('scrambleLetters');
            answerDiv.innerHTML = '';
            lettersDiv.innerHTML = '';

            shuffled.forEach((char, i) => {
                const btn = document.createElement('button');
                btn.className = 'scramble-letter';
                btn.textContent = char;
                btn.dataset.index = i;
                btn.onclick = () => addToScrambleAnswer(char, btn);
                lettersDiv.appendChild(btn);
            });
        }

        function addToScrambleAnswer(char, btn) {
            btn.classList.add('used');
            scrambleAnswer.push({ char, btn });

            const answerDiv = document.getElementById('scrambleAnswer');
            const letterEl = document.createElement('span');
            letterEl.className = 'scramble-answer-letter';
            letterEl.textContent = char;
            letterEl.onclick = () => removeFromScrambleAnswer(letterEl, btn);
            answerDiv.appendChild(letterEl);
        }

        function removeFromScrambleAnswer(letterEl, btn) {
            letterEl.remove();
            btn.classList.remove('used');
            scrambleAnswer = scrambleAnswer.filter(s => s.btn !== btn);
        }

        document.getElementById('scrambleSubmit').onclick = () => {
            const { def } = currentQuiz;
            const answer = scrambleAnswer.map(s => s.char).join('');

            if (answer === def.correct) {
                quizCorrect();
            } else {
                quizWrong(null, 'Wrong!');
            }
        };

        function setupFillQuiz(def) {
            document.getElementById('typeContainer').style.display = 'block';
            const input = document.getElementById('typeInput');
            // Only show first letter as hint, no full structure
            const firstLetter = def.correct.split(' ').map(w => w[0]).join(' ');
            document.getElementById('typeHint').textContent = `Starts with: ${firstLetter}`;
            input.value = '';
            input.placeholder = '';
            input.className = 'type-input';
            setTimeout(() => input.focus(), 100);
        }

        function setupTypeQuiz(def) {
            document.getElementById('typeContainer').style.display = 'block';
            const input = document.getElementById('typeInput');
            document.getElementById('typeHint').textContent = 'Type from memory!';
            input.value = '';
            input.placeholder = '';
            input.className = 'type-input';
            setTimeout(() => input.focus(), 100);
        }

        document.getElementById('typeSubmit').onclick = checkTypeAnswer;
        document.getElementById('typeInput').onkeydown = (e) => {
            if (e.key === 'Enter') checkTypeAnswer();
        };

        function checkTypeAnswer() {
            const { def } = currentQuiz;
            const input = document.getElementById('typeInput');
            const answer = input.value.trim().toLowerCase();

            if (answer === def.correct) {
                input.classList.add('correct');
                quizCorrect();
            } else {
                input.classList.add('wrong');
                quizWrong(null, 'Wrong!');
                setTimeout(() => {
                    input.classList.remove('wrong');
                    input.value = '';
                    input.focus();
                }, 1500);
            }
        }

        function quizCorrect(btn = null) {
            const { def, onCorrect } = currentQuiz;
            playSound('sfxCorrect', 0.5);

            if (btn) btn.classList.add('correct-choice');
            document.getElementById('quizContent').classList.add('correct');

            const feedback = document.getElementById('quizFeedback');
            feedback.className = 'quiz-feedback show correct';
            feedback.textContent = 'Correct!';

            // Increase mastery
            mastery[def.command] = (mastery[def.command] || 0) + 1;
            updateMasteryUI(def.command);

            setTimeout(() => {
                document.getElementById('quizModal').classList.remove('active');
                onCorrect();
                gameRunning = true;
            }, 1000);
        }

        function quizWrong(btn = null, message) {
            playSound('sfxWrong', 0.5);
            playSound('sfxDeath', 0.3);

            if (btn) btn.classList.add('wrong-choice');
            document.getElementById('quizContent').classList.add('wrong');

            const feedback = document.getElementById('quizFeedback');
            feedback.className = 'quiz-feedback show wrong';
            feedback.textContent = message + ' Back to checkpoint!';

            // PUNISHMENT: Reset ALL incomplete zones AND push player back to checkpoint!
            if (currentQuiz && currentQuiz.type === 'add') {
                // Reset ALL incomplete zones (not just current one)
                for (let i = 0; i < zoneStates.length; i++) {
                    if (!zoneStates[i].complete) {
                        zoneStates[i].collected = new Set();
                    }
                }
                terminalLog('<span class="error">‚úó Wrong! Back to checkpoint...</span>');
            }

            setTimeout(() => {
                document.getElementById('quizModal').classList.remove('active');
                document.getElementById('quizContent').classList.remove('wrong');
                if (btn) btn.classList.remove('wrong-choice');
                feedback.className = 'quiz-feedback';
                document.querySelectorAll('.quiz-option').forEach(b => b.style.pointerEvents = 'auto');
                currentZoneIndex = -1;

                // Push player back to last checkpoint (or start)
                if (lastCheckpoint) {
                    player.x = lastCheckpoint.x;
                    player.y = lastCheckpoint.y - player.height - 8;
                } else {
                    player.x = 50;
                    player.y = 280;
                }
                player.velX = 0;
                player.velY = 0;

                gameRunning = true;
            }, 2000);
        }

        // Keys
        const keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.code)) e.preventDefault();
        });
        document.addEventListener('keyup', e => { keys[e.code] = false; });

        // Start
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startScreen').classList.add('hidden');
            gameRunning = true;
            lives = 3;

            // Initialize puzzle zone states for first level
            zoneStates = (currentLevelData.puzzleZones || []).map(zone => ({
                collected: new Set(),
                complete: false
            }));

            const music = document.getElementById('bgMusic');
            music.volume = 0.12;
            music.play().catch(() => {});
            terminalLog('<span class="dim">---</span>');
            terminalLog('<span class="cmd">$ cd level-1</span>');
            gameLoop();
        });

        // === DEATH QUIZ SYSTEM ===
        let lives = 3;
        const deathCommands = [
            'git checkout',    // CORRECT - back to checkpoint
            'git reset --hard', // CORRECT - restart level (harsh)
            'git add',         // WRONG
            'git commit',      // WRONG
            'git push',        // WRONG
            'git pull',        // WRONG
            'git merge',       // WRONG
            'git stash',       // WRONG
            'git fetch',       // WRONG
            'git branch',      // WRONG
            'git clone',       // WRONG
            'git status',      // WRONG
        ];

        function updateLivesDisplay() {
            const hearts = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(Math.max(0, 3 - lives));
            document.getElementById('livesDisplay').textContent = hearts;
            document.getElementById('livesCount').textContent = '‚ù§Ô∏è'.repeat(lives);
        }

        function showDeathQuiz() {
            const grid = document.getElementById('deathGrid');
            grid.innerHTML = '';
            document.getElementById('deathFeedback').textContent = '';
            document.getElementById('deathFeedback').className = 'death-feedback';
            updateLivesDisplay();

            // Shuffle options
            const shuffled = [...deathCommands].sort(() => Math.random() - 0.5);
            shuffled.forEach(cmd => {
                const btn = document.createElement('button');
                btn.className = 'death-option';
                btn.textContent = cmd;
                btn.onclick = () => handleDeathChoice(cmd, btn);
                grid.appendChild(btn);
            });

            document.getElementById('deathModal').classList.add('active');
        }

        function handleDeathChoice(cmd, btn) {
            const feedback = document.getElementById('deathFeedback');

            if (cmd === 'git checkout') {
                // CORRECT - back to checkpoint
                btn.classList.add('correct');
                feedback.textContent = 'Correct!';
                feedback.className = 'death-feedback correct';
                playSound('sfxCorrect', 0.5);

                setTimeout(() => {
                    document.getElementById('deathModal').classList.remove('active');
                    terminalLog('<span class="cmd">$ git checkout HEAD</span>');
                    if (lastCheckpoint) {
                        player.x = lastCheckpoint.x;
                        player.y = lastCheckpoint.y - player.height - 8;
                    } else {
                        player.x = 50; player.y = 280;
                    }
                    player.velX = 0; player.velY = 0;
                    stagedFiles = [];
                    // Reset incomplete zones
                    for (let i = 0; i < zoneStates.length; i++) {
                        if (!zoneStates[i].complete) {
                            zoneStates[i].collected = new Set();
                        }
                    }
                    updateStats();
                    gameRunning = true;
                }, 800);

            } else if (cmd === 'git reset --hard') {
                // CORRECT but harsh - restart entire level
                btn.classList.add('correct');
                feedback.textContent = 'Correct! (Full reset...)';
                feedback.className = 'death-feedback correct';
                playSound('sfxCorrect', 0.5);

                setTimeout(() => {
                    document.getElementById('deathModal').classList.remove('active');
                    terminalLog('<span class="cmd">$ git reset --hard</span>');
                    loadLevel(currentLevel);
                    gameRunning = true;
                }, 800);

            } else {
                // WRONG - lose a life!
                btn.classList.add('wrong');
                btn.classList.add('disabled');
                lives--;
                updateLivesDisplay();
                playSound('sfxWrong', 0.5);
                feedback.textContent = 'Wrong! -1 life';
                feedback.className = 'death-feedback wrong';

                if (lives <= 0) {
                    // GAME OVER - restart level
                    feedback.textContent = 'GAME OVER! Restarting level...';
                    setTimeout(() => {
                        document.getElementById('deathModal').classList.remove('active');
                        lives = 3;
                        terminalLog('<span class="error">GAME OVER - Restarting...</span>');
                        loadLevel(currentLevel);
                        gameRunning = true;
                    }, 1500);
                }
            }
        }

        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            document.getElementById('levelComplete').classList.remove('active');
            if (currentLevel < levels.length) {
                loadLevel(currentLevel + 1);
            } else {
                const addM = mastery['git add'] || 0;
                const commitM = mastery['git commit'] || 0;
                const pushM = mastery['git push'] || 0;
                alert(`üéâ You mastered Git Galaxy!\n\nYour mastery levels:\n‚Ä¢ git add: ${addM}/10\n‚Ä¢ git commit: ${commitM}/10\n‚Ä¢ git push: ${pushM}/10`);
                loadLevel(1);
            }
            gameRunning = true;
        });

        function loadLevel(num) {
            currentLevel = num;
            currentLevelData = levels[num - 1];
            document.getElementById('levelNum').textContent = num;

            collectedFiles = [];
            stagedFiles = [];
            activeCheckpoints = [];
            lastCheckpoint = null;
            hasCheckpoint = false;
            lives = 3; // Reset lives on new level
            updateStats();

            // Initialize puzzle zone states
            zoneStates = (currentLevelData.puzzleZones || []).map(zone => ({
                collected: new Set(), // Which crystal indices have been collected
                complete: false       // Has this zone been fully completed (quiz passed)
            }));
            currentZoneIndex = -1;

            player.x = 50; player.y = 280;
            player.velX = 0; player.velY = 0;
            cameraX = 0;

            terminalLog('<span class="dim">---</span>');
            terminalLog(`<span class="cmd">$ cd level-${num}</span>`);
        }

        // Check if player is inside a puzzle zone
        function getPlayerZone() {
            const zones = currentLevelData.puzzleZones || [];
            for (let i = 0; i < zones.length; i++) {
                const z = zones[i];
                if (zoneStates[i] && zoneStates[i].complete) continue; // Skip completed zones
                if (player.x + player.width > z.zoneX && player.x < z.zoneX + z.zoneW &&
                    player.y + player.height > z.zoneY && player.y < z.zoneY + z.zoneH) {
                    return i;
                }
            }
            return -1;
        }

        // Collect a crystal within a puzzle zone
        function collectCrystal(zoneIndex, crystalIndex) {
            if (!zoneStates[zoneIndex]) return;
            if (zoneStates[zoneIndex].collected.has(crystalIndex)) return;

            playSound('sfxCollect', 0.4);
            zoneStates[zoneIndex].collected.add(crystalIndex);

            // Check if all crystals in zone collected
            const zone = currentLevelData.puzzleZones[zoneIndex];
            if (zoneStates[zoneIndex].collected.size >= zone.crystals.length) {
                // All crystals collected! Time for the quiz
                triggerZoneQuiz(zoneIndex);
            }
        }

        // Trigger the git add quiz for completing a puzzle zone
        function triggerZoneQuiz(zoneIndex) {
            gameRunning = false;
            currentZoneIndex = zoneIndex;
            const zone = currentLevelData.puzzleZones[zoneIndex];

            showQuiz('add', () => {
                // SUCCESS! Mark zone as complete
                zoneStates[zoneIndex].complete = true;
                collectedFiles.push(zone);
                stagedFiles.push(zone.name);
                updateStats();
                terminalLog(`<span class="cmd">$ git add ${zone.name}</span>`);
                terminalLog(`<span class="success">‚úì Staged</span>`);
                currentZoneIndex = -1;
            });
        }

        // Called when quiz answer is WRONG - reset the zone!
        function resetCurrentZone() {
            if (currentZoneIndex >= 0 && zoneStates[currentZoneIndex]) {
                // Reset all crystals in this zone
                zoneStates[currentZoneIndex].collected = new Set();
                terminalLog('<span class="error">‚úó Wrong! Redo the puzzle.</span>');
            }
        }

        function hitCheckpoint(cp) {
            if (activeCheckpoints.includes(cp)) return;
            gameRunning = false;

            showQuiz('commit', () => {
                activeCheckpoints.push(cp);
                lastCheckpoint = cp;
                hasCheckpoint = true;
                commitCount++;

                terminalLog('<span class="dim">---</span>');
                terminalLog(`<span class="cmd">$ git commit -m "checkpoint"</span>`);
                terminalLog(`<span class="commit">[main ${Math.random().toString(36).substr(2,5)}]</span> saved`);
                stagedFiles = [];
                updateStats();
            });
        }

        function reachGoal() {
            gameRunning = false;

            showQuiz('push', () => {
                terminalLog('<span class="dim">---</span>');
                terminalLog('<span class="cmd">$ git push origin main</span>');
                terminalLog('<span class="success">‚úì Level complete!</span>');

                setTimeout(() => {
                    document.getElementById('levelComplete').classList.add('active');
                    if (currentLevel >= levels.length) {
                        document.getElementById('nextLevelBtn').textContent = 'FINISH';
                    }
                }, 300);
            });
        }

        function playerDied() {
            gameRunning = false;
            playSound('sfxDeath', 0.4);
            showDeathQuiz();
        }

        function checkCollision(a, b) {
            return a.x < b.x + b.width && a.x + a.width > b.x &&
                   a.y < b.y + b.height && a.y + a.height > b.y;
        }

        function update() {
            if (keys['ArrowLeft'] || keys['KeyA']) {
                player.velX = -player.speed;
                player.facingRight = false;
            } else if (keys['ArrowRight'] || keys['KeyD']) {
                player.velX = player.speed;
                player.facingRight = true;
            } else {
                player.velX *= friction;
            }

            if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && player.onGround) {
                player.velY = -player.jumpPower;
                player.onGround = false;
                playSound('sfxJump', 0.2);
            }

            player.velY += gravity;
            player.x += player.velX;
            player.y += player.velY;

            player.onGround = false;
            for (const p of currentLevelData.platforms) {
                if (checkCollision(player, p)) {
                    if (player.velY > 0 && player.y + player.height - player.velY <= p.y + 4) {
                        player.y = p.y - player.height;
                        player.velY = 0;
                        player.onGround = true;
                    } else if (player.velY < 0 && player.y - player.velY >= p.y + p.height - 4) {
                        player.y = p.y + p.height;
                        player.velY = 0;
                    } else {
                        if (player.velX > 0) player.x = p.x - player.width;
                        else if (player.velX < 0) player.x = p.x + p.width;
                    }
                }
            }

            // Check crystal collection within puzzle zones
            const zones = currentLevelData.puzzleZones || [];
            for (let zi = 0; zi < zones.length; zi++) {
                if (!zoneStates[zi] || zoneStates[zi].complete) continue;
                const zone = zones[zi];
                for (let ci = 0; ci < zone.crystals.length; ci++) {
                    if (zoneStates[zi].collected.has(ci)) continue;
                    const c = zone.crystals[ci];
                    if (checkCollision(player, { x: c.x, y: c.y, width: 16, height: 16 })) {
                        collectCrystal(zi, ci);
                        if (!gameRunning) return; // Quiz triggered
                    }
                }
            }

            for (const cp of currentLevelData.checkpoints) {
                if (checkCollision(player, { x: cp.x, y: cp.y, width: 28, height: 32 })) {
                    hitCheckpoint(cp);
                    return;
                }
            }

            for (const s of currentLevelData.spikes || []) {
                if (checkCollision(player, s)) { playerDied(); return; }
            }

            const g = currentLevelData.goal;
            if (checkCollision(player, { x: g.x, y: g.y, width: 32, height: 32 })) {
                reachGoal();
                return;
            }

            if (player.x < 0) player.x = 0;
            if (player.x > currentLevelData.width - player.width) player.x = currentLevelData.width - player.width;
            if (player.y > 400) { playerDied(); return; }

            const targetX = player.x - canvas.width / 2 + (player.facingRight ? 80 : -80);
            cameraX += (targetX - cameraX) * CAMERA_LERP;
            cameraX = Math.max(0, Math.min(cameraX, currentLevelData.width - canvas.width));
        }

        function draw() {
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, currentLevelData.bg[0]);
            grad.addColorStop(1, currentLevelData.bg[1]);
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < 30; i++) {
                const x = ((i * 79 + currentLevel * 19) % (currentLevelData.width * 0.8)) - cameraX * 0.2;
                const y = (i * 37 + currentLevel * 13) % canvas.height;
                if (x > -5 && x < canvas.width + 5) {
                    ctx.beginPath();
                    ctx.arc(x, y, (i % 2) + 0.8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            ctx.save();
            ctx.translate(-cameraX, 0);

            ctx.fillStyle = '#4a4a6a';
            ctx.strokeStyle = '#6a6a8a';
            ctx.lineWidth = 2;
            for (const p of currentLevelData.platforms) {
                ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.strokeRect(p.x, p.y, p.width, p.height);
            }

            for (const pit of currentLevelData.pits || []) {
                ctx.fillStyle = 'rgba(255,50,50,0.1)';
                ctx.fillRect(pit.x, 350, pit.width, 30);
            }

            ctx.fillStyle = '#ff4757';
            for (const s of currentLevelData.spikes || []) {
                ctx.beginPath();
                for (let i = 0; i < s.width; i += 12) {
                    ctx.moveTo(s.x + i, s.y + s.height);
                    ctx.lineTo(s.x + i + 6, s.y);
                    ctx.lineTo(s.x + i + 12, s.y + s.height);
                }
                ctx.fill();
            }

            // Draw puzzle zones and crystals
            const zones = currentLevelData.puzzleZones || [];
            for (let zi = 0; zi < zones.length; zi++) {
                const zone = zones[zi];
                const state = zoneStates[zi];
                if (!state || state.complete) continue;

                // Draw zone boundary (subtle glow)
                const allCollected = state.collected.size >= zone.crystals.length;
                ctx.strokeStyle = zone.color;
                ctx.lineWidth = 2;
                ctx.globalAlpha = allCollected ? 0.8 : 0.25;
                ctx.setLineDash([8, 4]);
                ctx.strokeRect(zone.zoneX, zone.zoneY, zone.zoneW, zone.zoneH);
                ctx.setLineDash([]);
                ctx.globalAlpha = 1;

                // Draw file icon at zone center (as the goal)
                const iconX = zone.zoneX + zone.zoneW / 2 - 10;
                const iconY = zone.zoneY + 10;
                ctx.globalAlpha = 0.4;
                ctx.fillStyle = zone.color;
                ctx.fillRect(iconX, iconY, 20, 24);
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(iconX + 14, iconY, 6, 6);
                ctx.globalAlpha = 1;

                // Draw crystals
                for (let ci = 0; ci < zone.crystals.length; ci++) {
                    if (state.collected.has(ci)) continue;
                    const c = zone.crystals[ci];

                    // Crystal diamond shape
                    ctx.fillStyle = zone.color;
                    ctx.shadowColor = zone.color;
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.moveTo(c.x + 8, c.y);
                    ctx.lineTo(c.x + 16, c.y + 8);
                    ctx.lineTo(c.x + 8, c.y + 16);
                    ctx.lineTo(c.x, c.y + 8);
                    ctx.closePath();
                    ctx.fill();

                    // Shine
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.beginPath();
                    ctx.moveTo(c.x + 8, c.y + 2);
                    ctx.lineTo(c.x + 12, c.y + 8);
                    ctx.lineTo(c.x + 8, c.y + 8);
                    ctx.closePath();
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }

                // Show progress indicator
                const collected = state.collected.size;
                const total = zone.crystals.length;
                ctx.fillStyle = '#fff';
                ctx.font = '10px Nunito';
                ctx.textAlign = 'center';
                ctx.globalAlpha = 0.7;
                ctx.fillText(`${collected}/${total}`, zone.zoneX + zone.zoneW / 2, zone.zoneY + zone.zoneH - 5);
                ctx.globalAlpha = 1;
            }

            for (const cp of currentLevelData.checkpoints) {
                const active = activeCheckpoints.includes(cp);
                ctx.fillStyle = '#555';
                ctx.fillRect(cp.x + 10, cp.y, 4, 32);
                ctx.fillStyle = active ? '#27ca40' : '#a855f7';
                ctx.shadowColor = active ? '#27ca40' : '#a855f7';
                ctx.shadowBlur = active ? 10 : 4;
                ctx.beginPath();
                ctx.moveTo(cp.x + 14, cp.y);
                ctx.lineTo(cp.x + 32, cp.y + 9);
                ctx.lineTo(cp.x + 14, cp.y + 18);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            const goal = currentLevelData.goal;
            ctx.fillStyle = '#27ca40';
            ctx.shadowColor = '#27ca40';
            ctx.shadowBlur = 14;
            ctx.beginPath();
            const cx = goal.x + 16, cy = goal.y + 16;
            for (let i = 0; i < 10; i++) {
                const angle = (i * Math.PI / 5) - Math.PI / 2;
                const r = i % 2 === 0 ? 14 : 6;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = '#00d9ff';
            ctx.shadowColor = '#00d9ff';
            ctx.shadowBlur = 5;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(player.x + 4, player.y + 4, 16, 8);
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillRect(player.x + 5, player.y + 5, 4, 4);

            ctx.restore();

            const prog = player.x / currentLevelData.width;
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(canvas.width/2 - 70, canvas.height - 12, 140, 5);
            ctx.fillStyle = '#a855f7';
            ctx.fillRect(canvas.width/2 - 70, canvas.height - 12, 140 * prog, 5);
        }

        function gameLoop() {
            if (gameRunning) update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        draw();
    </script>
</body>
</html>
